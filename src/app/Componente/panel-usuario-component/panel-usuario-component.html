<app-header-panel-component/>
<div class="page-wrapper">
  <div class="panel-wrapper">
    <div class="panel-card">

      <div class="panel-header">
        <h2 class="panel-title">Panel de Gesti√≥n de {{ vistaActual() === 'usuarios' ? 'Usuarios' : 'Roles' }}</h2>
        <div class="header-actions">
          <button class="action-btn action-primary"
                  (click)="vistaActual() === 'usuarios' ? onRegistrarUsuarioClick() : onRegistrarRolClick()">
            Registrar Nuevo {{ vistaActual() === 'usuarios' ? 'Usuario' : 'Rol' }}
          </button>

          <div class="search-box">
            <input type="number" class="search-input" placeholder="Buscar por ID..."
                   [ngModel]="vistaActual() === 'usuarios' ? searchIdUsuario() : searchIdRol()"
                   (ngModelChange)="vistaActual() === 'usuarios' ? searchIdUsuario.set($event) : searchIdRol.set($event)" />
            <button class="search-btn" (click)="vistaActual() === 'usuarios' ? buscarPorIdUsuario() : buscarPorIdRol()">Buscar</button>
            <button class="search-btn-secondary" (click)="vistaActual() === 'usuarios' ? limpiarBusquedaUsuario() : limpiarBusquedaRol()">Limpiar</button>
          </div>
        </div>
      </div>

      <div class="tab-menu">
        <button class="tab-btn" [class.active]="vistaActual() === 'usuarios'" (click)="cambiarVista('usuarios')">üë§ Usuarios</button>
        <button class="tab-btn" [class.active]="vistaActual() === 'roles'" (click)="cambiarVista('roles')">üîë Roles de Sistema</button>
      </div>

      <section class="panel-main">

        @if (vistaActual() === 'usuarios') {
          @if (!showFormUsuario()) {
            <div class="table-card">
              <div class="table-header user-header">
                <span>ID</span>
                <span>Nombre Completo</span>
                <span>Correo (Username)</span>
                <span>Rol</span>
                <span>Fecha Registro</span>
                <span>Acciones</span>
              </div>
              <div class="table-body">
                @for (u of usuariosFiltrados(); track u.id) {
                  <div class="table-row user-row">
                    <span>{{ u.id }}</span>
                    <span>{{ u.nombre }} {{ u.apellido }}</span>
                    <span>{{ u.username }}</span>
                    <span [class]="rolClass(getRoleName(u))">{{ getRoleName(u) }}</span>
                    <span>{{ u.fechaRegistro }}</span>
                    <span class="cell-actions">
                      <button class="icon-btn view" (click)="verDetalleUsuario(u)">üëÅ</button>
                      <button class="icon-btn edit" (click)="editarUsuario(u)">‚úèÔ∏è</button>
                      <button class="icon-btn delete" (click)="eliminarUsuario(u)">üóë</button>
                    </span>
                  </div>
                } @empty { <div class="p-4 text-center">No hay usuarios.</div> }
              </div>
            </div>
          } @else {
            <div class="form-card">
              <h3>{{ editingIdUsuario() ? 'Editar usuario' : 'Registrar nuevo usuario' }}</h3>
              <div class="form-row">
                <label class="form-label">Nombres (*)</label>
                <input class="form-input" type="text" [(ngModel)]="usuarioForm.nombre" required />
              </div>
              <div class="form-row">
                <label class="form-label">Apellidos (*)</label>
                <input class="form-input" type="text" [(ngModel)]="usuarioForm.apellido" required />
              </div>
              <div class="form-row">
                <label class="form-label">Correo (Username) (*)</label>
                <input class="form-input" type="email" [(ngModel)]="usuarioForm.username" required />
              </div>
              <div class="form-row">
                <label class="form-label">Contrase√±a</label>
                <input class="form-input" type="password" [(ngModel)]="usuarioForm.password"
                       [placeholder]="editingIdUsuario() ? 'Dejar vac√≠o para mantener actual' : 'Obligatorio si es nuevo'" />
              </div>

              <div class="form-row">
                <label class="form-label">Rol del Sistema (*)</label>
                <select class="form-input" [(ngModel)]="selectedRoleForUser">
                  <option [ngValue]="null">Seleccione un rol</option>
                  @for (rol of roles(); track rol.id) {
                    <option [ngValue]="rol">{{ rol.name }}</option>
                  }
                </select>
              </div>

              <div class="form-actions">
                <button class="form-btn-secondary" (click)="cancelarFormUsuario()">Cancelar</button>
                <button class="form-btn-primary" (click)="guardarUsuario()">Guardar</button>
              </div>
            </div>
          }
        }

        @if (vistaActual() === 'roles') {
          @if (!showFormRol()) {
            <div class="table-card">
              <div class="table-header role-header">
                <span>ID</span>
                <span>Nombre del Rol</span>
                <span>Acciones</span>
              </div>
              <div class="table-body">
                @for (r of rolesFiltrados(); track r.id) {
                  <div class="table-row role-row">
                    <span>{{ r.id }}</span>
                    <span>{{ r.name }}</span> <span class="cell-actions">
                      <button class="icon-btn edit" (click)="editarRol(r)">‚úèÔ∏è</button>
                      <button class="icon-btn delete" (click)="eliminarRol(r)">üóë</button>
                    </span>
                  </div>
                }
              </div>
            </div>
          } @else {
            <div class="form-card">
              <h3>{{ editingIdRol() ? 'Editar Rol' : 'Registrar Nuevo Rol' }}</h3>
              <div class="form-row">
                <label class="form-label">Nombre del Rol (*)</label>
                <input class="form-input" type="text" [(ngModel)]="rolForm.name" placeholder="Ej: ROLE_EDITOR" required />
              </div>
              <div class="form-actions">
                <button class="form-btn-secondary" (click)="cancelarFormRol()">Cancelar</button>
                <button class="form-btn-primary" (click)="guardarRol()">Guardar</button>
              </div>
            </div>
          }
        }

        @if (detailOpenUsuario()) {
          <div class="modal-backdrop" (click)="cerrarDetalleUsuario()">
            <div class="modal-card pretty" (click)="$event.stopPropagation()">
              <header class="modal-header pretty">
                <h3 class="modal-title">Detalle de Usuario #{{ detalleSeleccionadoUsuario()?.id }}</h3>
                <button class="modal-close" (click)="cerrarDetalleUsuario()">‚úñ</button>
              </header>
              <div class="modal-body">
                <p><strong>Nombre:</strong> {{ detalleSeleccionadoUsuario()?.nombre }} {{ detalleSeleccionadoUsuario()?.apellido }}</p>
                <p><strong>Correo:</strong> {{ detalleSeleccionadoUsuario()?.username }}</p>
                <p><strong>Rol:</strong> {{ getRoleName(detalleSeleccionadoUsuario()!) }}</p>
                <p><strong>Fecha Registro:</strong> {{ detalleSeleccionadoUsuario()?.fechaRegistro }}</p>
              </div>
            </div>
          </div>
        }

      </section>
    </div>
  </div>
</div>
