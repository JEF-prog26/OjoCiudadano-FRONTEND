<app-header-panel-component/>
<div class="page-wrapper">
  <div class="panel-wrapper">
    <div class="panel-card">
      <!-- üîπ CABECERA CON T√çTULO, BOT√ìN Y BUSCADOR -->
      <div class="panel-header">
        <h2 class="panel-title">Panel de Gesti√≥n de Obras P√∫blicas</h2>

        <div class="header-actions">
          <button class="action-btn action-primary" (click)="onRegistrarClick()">
            Registrar Obra P√∫blica
          </button>

          <div class="search-box">
            <input
              type="number"
              class="search-input"
              placeholder="Buscar por ID..."
              [(ngModel)]="searchId"
            />
            <button class="search-btn" (click)="buscarPorId()">Buscar</button>
            <button class="search-btn-secondary" (click)="limpiarBusqueda()">Limpiar</button>
          </div>
        </div>
      </div>

      <!-- üîπ CONTENIDO PRINCIPAL -->
      <section class="panel-main">
        <!-- LISTA / TABLA -->
        <ng-container *ngIf="!showForm; else formularioRegistro">
          <div class="table-card">
            <!-- TABLA HEADER -->
            <div class="table-header">
              <span>ID</span>
              <span>Nombre</span>
              <span>Fechas</span>
              <span>Estado</span>
              <span>ID Gob.</span>
              <span>ID Exp.</span>
              <span>Acciones</span>
            </div>

            <div class="table-body">
              <div class="table-row-obra" *ngFor="let o of obrasFiltradas">
                <span class="mono">{{ o.id }}</span>
                <span class="truncate-text" title="{{ o.nombre }}">{{ o.nombre }}</span>
                <!-- Fechas combinadas -->
                <span class="date-range">
                    <span class="date-start">{{ o.fechaInicio }}</span>
                    <span class="date-end">{{ o.fechaFin }}</span>
                </span>
                <!-- Estado con estilo -->
                <span>
                    <span class="status-badge" [ngClass]="getEstadoClass(o.estado)">
                        {{ o.estado }}
                    </span>
                </span>
                <span class="mono">{{ o.idGobierno }}</span>
                <span class="mono">{{ o.idExpediente }}</span>
                <span class="cell-actions">
                  <button class="icon-btn view" (click)="verDetalle(o)" title="Ver Detalle">üëÅ</button>
                  <button class="icon-btn edit" (click)="editarObra(o)" title="Editar">‚úèÔ∏è</button>
                  <button class="icon-btn delete" (click)="eliminarObra(o)" title="Eliminar">üóë</button>
                </span>
              </div>
            </div>

            <!-- Scrollbars decorativos (ocultos en CSS) -->
            <div class="scrollbar-horizontal"></div>
            <div class="scrollbar-vertical"></div>
          </div>
        </ng-container>

        <!-- FORMULARIO (CREAR / EDITAR) -->
        <ng-template #formularioRegistro>
          <div class="form-card">
            <h3>{{ editingId ? 'Editar Obra P√∫blica' : 'Registrar nueva Obra P√∫blica' }}</h3>

            <div class="form-grid">
              <div class="form-row">
                <label class="form-label">ID</label>
                <input class="form-input" type="number" [(ngModel)]="obraForm.id" [readonly]="editingId !== null" />
              </div>
              <div class="form-row">
                <label class="form-label">Nombre</label>
                <input class="form-input" type="text" [(ngModel)]="obraForm.nombre" />
              </div>
              <div class="form-row">
                <label class="form-label">Fecha de Inicio</label>
                <input class="form-input" type="date" [(ngModel)]="obraForm.fechaInicio" />
              </div>
              <div class="form-row">
                <label class="form-label">Fecha de Fin</label>
                <input class="form-input" type="date" [(ngModel)]="obraForm.fechaFin" />
              </div>
              <div class="form-row">
                <label class="form-label">Estado</label>
                <select class="form-input" [(ngModel)]="obraForm.estado">
                  <option *ngFor="let estado of estadosDisponibles" [ngValue]="estado">{{ estado }}</option>
                </select>
              </div>
              <div class="form-row">
                <label class="form-label">ID Gobierno Regional</label>
                <input class="form-input" type="number" [(ngModel)]="obraForm.idGobierno" />
              </div>
              <div class="form-row">
                <label class="form-label">ID Expediente T√©cnico</label>
                <input class="form-input" type="number" [(ngModel)]="obraForm.idExpediente" />
              </div>
              <!-- Campo de Descripci√≥n ocupa todo el ancho -->
              <div class="form-row full-width">
                <label class="form-label">Descripci√≥n</label>
                <textarea class="form-input" [(ngModel)]="obraForm.descripcion" rows="3"></textarea>
              </div>
            </div>


            <div class="form-actions">
              <button class="form-btn-secondary" (click)="cancelarForm()">Cancelar</button>
              <button class="form-btn-primary" (click)="guardarObra()">
                {{ editingId ? 'Guardar cambios' : 'Registrar' }}
              </button>
            </div>
          </div>
        </ng-template>

        <!-- üß© MODAL DETALLE -->
        <div class="modal-backdrop" *ngIf="detailOpen" (click)="cerrarDetalle()">
          <section
            class="modal-card pretty"
            role="dialog"
            aria-modal="true"
            aria-labelledby="detalleTitle"
            (click)="$event.stopPropagation()"
          >
            <header class="modal-header pretty">
              <div class="title-wrap">
                <div class="title-icon">üèóÔ∏è</div>
                <div>
                  <h3 id="detalleTitle" class="modal-title">Obra P√∫blica #{{ detalleSeleccionado?.id }}</h3>
                  <p class="modal-subtitle">{{ detalleSeleccionado?.nombre || '‚Äî' }}</p>
                </div>
              </div>
              <button class="modal-close" (click)="cerrarDetalle()" aria-label="Cerrar">‚úñ</button>
            </header>

            <div class="modal-body">
              <!-- Detalles -->
              <div class="detail-section card">
                <h4 class="section-title">Detalles y Referencias</h4>

                <div class="meta-grid">
                  <div class="meta">
                    <span class="meta-label">ID Obra</span>
                    <span class="meta-value mono">#{{ detalleSeleccionado?.id }}</span>
                  </div>

                  <div class="meta">
                    <span class="meta-label">Estado</span>
                    <span class="meta-value">
                        <span class="status-badge" [ngClass]="getEstadoClass(detalleSeleccionado?.estado || 'Pendiente')">
                            {{ detalleSeleccionado?.estado || '‚Äî' }}
                        </span>
                    </span>
                  </div>

                  <div class="meta">
                    <span class="meta-label">ID Gobierno Regional</span>
                    <span class="meta-value mono">{{ detalleSeleccionado?.idGobierno || '‚Äî' }}</span>
                  </div>

                  <div class="meta">
                    <span class="meta-label">ID Expediente T√©cnico</span>
                    <span class="meta-value mono">{{ detalleSeleccionado?.idExpediente || '‚Äî' }}</span>
                  </div>

                  <div class="meta full">
                    <span class="meta-label">Per√≠odo de Ejecuci√≥n</span>
                    <span class="meta-value mono">{{ detalleSeleccionado?.fechaInicio || '‚Äî' }} ‚Äî {{ detalleSeleccionado?.fechaFin || '‚Äî' }}</span>
                  </div>

                  <div class="meta full">
                    <span class="meta-label">Descripci√≥n</span>
                    <p class="meta-value multiline">{{ detalleSeleccionado?.descripcion || 'No proporcionada' }}</p>
                  </div>
                </div>
              </div>

            </div>
          </section>
        </div>
      </section>
    </div>
  </div>

  <footer class="bottom-bar"></footer>
</div>
