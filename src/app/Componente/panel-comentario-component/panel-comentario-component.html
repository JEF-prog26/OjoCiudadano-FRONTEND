<div class="page-wrapper">
  <header class="top-bar">
    <button class="back-button" (click)="goBack()">
      &lt; Volver a la p√°gina anterior
    </button>
  </header>
  <div class="panel-wrapper">
    <div class="panel-card">
      <!-- üîπ CABECERA CON T√çTULO, BOT√ìN Y BUSCADOR -->
      <div class="panel-header">
        <h2 class="panel-title">Panel de Gesti√≥n de Comentarios</h2>
        <div class="header-actions">
          <button class="action-btn action-primary" (click)="onRegistrarClick()">
            Registrar Comentario
          </button>
          <div class="search-box">
            <input
              type="number"
              class="search-input"
              placeholder="Buscar por ID..."
              [(ngModel)]="searchId"
            />
            <button class="search-btn" (click)="buscarPorId()">Buscar</button>
            <button class="search-btn-secondary" (click)="limpiarBusqueda()">Limpiar</button>
          </div>
        </div>
      </div>
      <!-- üîπ CONTENIDO PRINCIPAL -->
      <section class="panel-main">

        <ng-container *ngIf="!showForm; else formularioRegistro">

          <div class="dashboard-grid">

            <section class="chat-section">
              <div class="chat-header">
                <h3>Comentarios en vivo</h3>
                <span class="badge-count">{{ comentariosFiltrados.length }}</span>
              </div>

              <div class="chat-feed">
                <div class="chat-bubble" *ngFor="let d of comentariosFiltrados">
                  <div class="avatar-placeholder">{{ d.descripcion.charAt(0).toUpperCase() }}</div>
                  <div class="bubble-content">
                    <div class="bubble-meta">
                      <span class="bubble-id">#{{ d.id }}</span>
                      <span class="bubble-date">{{ d.fechaComentario }}</span>
                    </div>
                    <p class="bubble-text">{{ d.descripcion }}</p>
                    <span class="bubble-status" [ngClass]="estadoClass(d.estado)">{{ d.estado }}</span>
                  </div>
                </div>
                <div *ngIf="comentariosFiltrados.length === 0" class="empty-chat">
                  No hay comentarios para mostrar.
                </div>
              </div>

              <div class="chat-input-area">
                <input
                  type="text"
                  class="chat-input"
                  placeholder="Escribe un comentario aqu√≠..."
                  [(ngModel)]="nuevoComentarioTexto"
                  (keyup.enter)="registrarRapido()"
                >
                <button class="send-btn" (click)="registrarRapido()">‚û§</button>
              </div>
            </section>

            <section class="admin-section">
              <div class="admin-header">
                <h3>Base de Datos</h3>
              </div>

              <div class="table-card">
                <div class="table-header">
                  <span>ID</span>
                  <span>Descripci√≥n</span>
                  <span>Fecha</span>
                  <span>Estado</span>
                  <span>Acciones</span>
                </div>

                <div class="table-body">
                  <div class="table-row" *ngFor="let d of comentariosFiltrados">
                    <span>{{ d.id }}</span>
                    <span [title]="d.descripcion">{{ d.descripcion }}</span>
                    <span>{{ d.fechaComentario }}</span>
                    <span>{{ d.estado }}</span>
                    <span class="cell-actions">
                      <button class="icon-btn view" (click)="verDetalle(d)">üëÅ</button>
                      <button class="icon-btn edit" (click)="editarComentario(d)">‚úèÔ∏è</button>
                      <button class="icon-btn delete" (click)="eliminarComentario(d)">üóë</button>
                    </span>
                  </div>
                </div>
              </div>
            </section>

          </div>
        </ng-container>

        <ng-template #formularioRegistro>
          <div class="form-card">
            <h3>{{ editingId ? 'Editar Comentario' : 'Registrar nuevo Comentario' }}</h3>

            <div class="form-row">
              <label class="form-label">ID</label>
              <input
                class="form-input"
                type="text"
                [value]="editingId ? comentarioForm.id : 'Autogenerado'"
                readonly
                disabled
              />
            </div>

            <div class="form-row">
              <label class="form-label">Descripci√≥n</label>
              <textarea
                class="form-input"
                rows="3"
                [(ngModel)]="comentarioForm.descripcion">
              </textarea>
            </div>

            <div class="form-row">
              <label class="form-label">Estado</label>
              <input class="form-input" type="text" [(ngModel)]="comentarioForm.estado" />
            </div>

            <div class="form-actions">
              <button class="form-btn-secondary" (click)="cancelarForm()">Cancelar</button>
              <button class="form-btn-primary" (click)="guardarComentario()">
                {{ editingId ? 'Guardar cambios' : 'Registrar' }}
              </button>
            </div>
          </div>
        </ng-template>

        <div class="modal-backdrop" *ngIf="detailOpen" (click)="cerrarDetalle()">
          <section
            class="modal-card pretty"
            role="dialog"
            aria-modal="true"
            aria-labelledby="detalleTitle"
            (click)="$event.stopPropagation()"
          >
            <header class="modal-header pretty">
              <div class="title-wrap">
                <div class="title-icon">üóÇÔ∏è</div>
                <div>
                  <h3 id="detalleTitle" class="modal-title">Comentario #{{ detalleSeleccionado?.id }}</h3>
                  <p class="modal-subtitle">{{ detalleSeleccionado?.titulo || '‚Äî' }}</p>
                </div>
              </div>
              <button class="modal-close" (click)="cerrarDetalle()" aria-label="Cerrar">‚úñ</button>
            </header>

            <div class="modal-body">
              <div class="detail-section card">
                <h4 class="section-title">Detalles generales</h4>

                <div class="meta-grid">
                  <div class="meta">
                    <span class="meta-label">ID</span>
                    <span class="meta-value mono">#{{ detalleSeleccionado?.id }}</span>
                  </div>

                  <div class="meta full">
                    <span class="meta-label">Descripci√≥n</span>
                    <p class="meta-value multiline">{{ detalleSeleccionado?.descripcion || '‚Äî' }}</p>
                  </div>

                  <div class="meta">
                    <span class="meta-label">Estado actual</span>
                    <span class="badge big" [ngClass]="estadoClass(detalleSeleccionado?.estado)">
                      {{ detalleSeleccionado?.estado || '‚Äî' }}
                    </span>
                  </div>
                </div>
              </div>

              <div class="divider"></div>

              <div class="detail-section card">
                <h4 class="section-title">Seguimiento</h4>
                <ul class="timeline pretty">
                  <li class="timeline-item" *ngFor="let h of detalleSeleccionado?.historial">
                    <div class="timeline-dot" [ngClass]="estadoClass(h.estado)"></div>
                    <div class="timeline-content">
                      <div class="timeline-head">
                        <span class="timeline-state" [ngClass]="estadoClass(h.estado)">{{ h.estado }}</span>
                        <span class="timeline-date">{{ h.fecha }}</span>
                      </div>
                      <p class="timeline-desc">{{ h.descripcion || '‚Äî' }}</p>
                    </div>
                  </li>
                  <li *ngIf="!detalleSeleccionado?.historial?.length" class="timeline-empty">
                    A√∫n no hay eventos registrados.
                  </li>
                </ul>
              </div>
            </div>

            <div class="modal-footer pretty">
              <div class="footer-left"></div>
              <div class="footer-actions">
                <button class="btn-neutral" (click)="cerrarDetalle()">Cerrar</button>
              </div>
            </div>

          </section>
        </div>

      </section>
    </div>
  </div>
  <footer class="bottom-bar"></footer>
</div>
